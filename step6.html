<!DOCTYPE html><html><head><meta charset="utf-8" /><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /> <!--metatextblock--><title>STEP6</title><meta property="og:url" content="http://project8244563.tilda.ws/step6" /><meta property="og:title" content="STEP6" /><meta property="og:description" content="" /><meta property="og:type" content="website" /><link rel="canonical" href="step6.html"><!--/metatextblock--><meta name="format-detection" content="telephone=no" /><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://ws.tildacdn.com"><link rel="dns-prefetch" href="https://static.tildacdn.info"><meta name="robots" content="nofollow" /><link rel="shortcut icon" href="https://static.tildacdn.info/img/tildafavicon.ico" type="image/x-icon" /><!-- Assets --><script src="https://neo.tildacdn.com/js/tilda-fallback-1.0.min.js" async charset="utf-8"></script><link rel="stylesheet" href="https://static.tildacdn.info/css/tilda-grid-3.0.min.css" type="text/css" media="all" onerror="this.loaderr='y';"/><link rel="stylesheet" href="tilda-blocks-page41823828.min.css@t=1702796426.css" type="text/css" media="all" onerror="this.loaderr='y';" /><link rel="stylesheet" href="https://static.tildacdn.info/css/highlight.min.css" type="text/css" media="all" onerror="this.loaderr='y';" /><link rel="stylesheet" href="https://static.tildacdn.info/css/fonts-tildasans.css" type="text/css" media="all" onerror="this.loaderr='y';" /><script nomodule src="https://static.tildacdn.info/js/tilda-polyfill-1.0.min.js" charset="utf-8"></script><script type="text/javascript">function t_onReady(func) {
if (document.readyState != 'loading') {
func();
} else {
document.addEventListener('DOMContentLoaded', func);
}
}
function t_onFuncLoad(funcName, okFunc, time) {
if (typeof window[funcName] === 'function') {
okFunc();
} else {
setTimeout(function() {
t_onFuncLoad(funcName, okFunc, time);
},(time || 100));
}
}</script><script src="https://static.tildacdn.info/js/tilda-scripts-3.0.min.js" charset="utf-8" defer onerror="this.loaderr='y';"></script><script src="tilda-blocks-page41823828.min.js@t=1702796426" charset="utf-8" async onerror="this.loaderr='y';"></script><script src="https://static.tildacdn.info/js/tilda-lazyload-1.0.min.js" charset="utf-8" async onerror="this.loaderr='y';"></script><script src="https://static.tildacdn.info/js/highlight.min.js" charset="utf-8" onerror="this.loaderr='y';"></script><script src="https://static.tildacdn.info/js/tilda-events-1.0.min.js" charset="utf-8" async onerror="this.loaderr='y';"></script><script type="text/javascript">window.dataLayer = window.dataLayer || [];</script><script type="text/javascript">(function () {
if((/bot|google|yandex|baidu|bing|msn|duckduckbot|teoma|slurp|crawler|spider|robot|crawling|facebook/i.test(navigator.userAgent))===false && typeof(sessionStorage)!='undefined' && sessionStorage.getItem('visited')!=='y' && document.visibilityState){
var style=document.createElement('style');
style.type='text/css';
style.innerHTML='@media screen and (min-width: 980px) {.t-records {opacity: 0;}.t-records_animated {-webkit-transition: opacity ease-in-out .2s;-moz-transition: opacity ease-in-out .2s;-o-transition: opacity ease-in-out .2s;transition: opacity ease-in-out .2s;}.t-records.t-records_visible {opacity: 1;}}';
document.getElementsByTagName('head')[0].appendChild(style);
function t_setvisRecs(){
var alr=document.querySelectorAll('.t-records');
Array.prototype.forEach.call(alr, function(el) {
el.classList.add("t-records_animated");
});
setTimeout(function () {
Array.prototype.forEach.call(alr, function(el) {
el.classList.add("t-records_visible");
});
sessionStorage.setItem("visited", "y");
}, 400);
} 
document.addEventListener('DOMContentLoaded', t_setvisRecs);
}
})();</script></head><body class="t-body" style="margin:0;"><!--allrecords--><div id="allrecords" class="t-records" data-hook="blocks-collection-content-node" data-tilda-project-id="8244563" data-tilda-page-id="41823828" data-tilda-page-alias="step6" data-tilda-formskey="0256e5b780ccc9c376d7cc1458244563" data-tilda-cookie="no" data-tilda-lazy="yes" ><div id="rec676025390" class="r t-rec t-rec_pt_105 t-rec_pb_90" style="padding-top:105px;padding-bottom:90px; " data-record-type="30" ><!-- T015 --><div class="t015"><div class="t-container t-align_center"><div class="t-col t-col_10 t-prefix_1"><div class="t015__uptitle t-uptitle t-uptitle_md" field="subtitle"><p style="text-align: center;"><strong>[DragAcceptFiles, DragQueryFile]</strong></p></div> <div class="t015__title t-title t-title_lg" field="title"><p style="text-align: center;">Шаг 6 - Прием файлов Drag'n'Drop</p></div> </div></div></div><style> #rec676025390 .t015__uptitle { text-transform: uppercase; }</style></div><div id="rec676025391" class="r t-rec t-rec_pt_60 t-rec_pb_60" style="padding-top:60px;padding-bottom:60px;background-color:#1f5bff; " data-record-type="488" data-bg-color="#1f5bff"><!-- t488 --><div class="t488"><div class="t-container t-align_left"><div class="t-col t-col_12 "><div class="t488__uptitle t-uptitle t-uptitle_lg " field="subtitle"><p style="text-align: left;">Хранилище объектов</p></div> <div class="t488__descr t-title t-title_xl " field="descr"><div style="font-size: 24px;" data-customstyle="yes">Известный и распространенный метод открытия файлов — перетаскивание их в окно приложения. Для поддержки этой функциональности в WinAPI используются функции DragAcceptFiles() и DragQueryFile(). Первая указывает Windows, что окно готово принимать файлы, и обычно вызывается при инициализации программы, например, в методе FormCreate(). Вторая предоставляет информацию о перетаскиваемых файлах.<br /><br />Отметим, что для обработки этого события Windows требуется создание таблицы откликов MESSAGE_MAP, аналогичной стилю Visual C++ или OWL. Такая таблица включается в описание класса и указывает, какая процедура-обработчик события будет вызвана. Более подробные детали синтаксиса таблицы будут рассмотрены в следующих шагах.<br /><br /></div></div> </div></div></div><style> #rec676025391 .t488__uptitle { text-transform: uppercase; }</style></div><div id="rec676025394" class="r t-rec t-rec_pt_75 t-rec_pb_90" style="padding-top:75px;padding-bottom:90px;background-color:#ffffff; " data-animationappear="off" data-record-type="285" data-bg-color="#ffffff"><!-- t264 --><div class="t264"><div class="t-container"><div class="t-col t-col_10 t-prefix_2"><div class="t264__title t-title t-title_xs" field="title">В секцию <strong>private</strong>&nbsp;класса <strong>TMainForm</strong>&nbsp;нужно вставить описание функции-обработчика, функции-диспетчера и таблицу откликов:</div> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="cpp">
private:
	void __fastcall CreateMDIChild(const String Name,bool img);
	void __fastcall WmDropFiles(TWMDropFiles&amp; Message);
	void __fastcall ReadFile(AnsiString FileName);
public:
	virtual __fastcall TMainForm(TComponent *Owner);
	BEGIN_MESSAGE_MAP
		MESSAGE_HANDLER(WM_DROPFILES,TWMDropFiles,WmDropFiles)
	END_MESSAGE_MAP(TForm);
</code></pre></div></div></div></div><script type="text/javascript">t_onReady(function () {
var rec = document.getElementById('rec676025394');
var rawCode = rec.querySelector('pre code');
rawCode.textContent = rawCode.textContent.trim()
t_onFuncLoadObj(hljs.initHighlightingOnLoad);
function t_onFuncLoadObj(okFunc) {
if (typeof hljs.initHighlightingOnLoad === 'function') {
okFunc();
} else {
setTimeout(function checkFuncExist() {
if (typeof hljs.initHighlightingOnLoad === 'function') {
okFunc();
return;
}
if (document.readyState === 'complete' && typeof hljs.initHighlightingOnLoad !== 'function') {
throw new Error('hljs.initHighlightingOnLoad' + ' is undefined');
}
setTimeout(checkFuncExist, 100);
});
}
}
});</script><style type="text/css">.t264 .hljs { 
background-color: ;
}</style> </div><div id="rec676028174" class="r t-rec t-rec_pt_75 t-rec_pb_90" style="padding-top:75px;padding-bottom:90px;background-color:#1f5bff; " data-animationappear="off" data-record-type="285" data-bg-color="#1f5bff"><!-- t264 --><div class="t264"><div class="t-container"><div class="t-col t-col_10 t-prefix_2"><div class="t264__title t-title t-title_xs" field="title"><span style="color: rgb(255, 255, 255);">Диспетчер ReadFile() полезен, чтобы избежать дублирования кода. Несмотря на свой громоздкий вид, он не зависит от фильтра диалога. Вот изменения в основном файле:</span></div> <div class="t264__wrapper t-text t-text_xs" style="border: 0px solid #f8f8f8;"><pre><code class="cpp">
#include &lt;dir.h&gt;

__fastcall TMainForm::TMainForm(TComponent *Owner)
	: TForm(Owner)
{
	DragAcceptFiles(Handle,true);
}

void __fastcall TMainForm::WmDropFiles(TWMDropFiles&amp; Message)
{
	HDROP drop_handle=(HDROP)Message.Drop;
	char fName[MAXPATH];
	int filenum=DragQueryFile(drop_handle,-1,NULL,NULL);
	for (int i=0;i&lt;filenum;i++)
	{
		DragQueryFile(drop_handle,i,fName,MAXPATH);
		ReadFile(fName);
	};
	DragFinish(drop_handle);
};

void __fastcall TMainForm::ReadFile(AnsiString FileName)
{
	String str=ExtractFileExt(FileName);
	if((str==&quot;.avi&quot;)||(str==&quot;.wav&quot;)||(str==&quot;.mid&quot;)||(str==&quot;.mov&quot;))
	{
		MediaPlayer1-&gt;FileName=FileName;
		MediaPlayer1-&gt;Open();
		MediaPlayer1-&gt;Play();
	}
	else
	if((str==&quot;.bmp&quot;)||(str==&quot;.ico&quot;)||(str==&quot;.wmf&quot;))
		CreateMDIChild(FileName,true);
	else
		CreateMDIChild(FileName,false);
};

void __fastcall TMainForm::FileOpen1Execute(TObject *Sender)
{
	if (OpenDialog-&gt;Execute())
		ReadFile(OpenDialog-&gt;FileName);
}
</code></pre></div></div></div></div><script type="text/javascript">t_onReady(function () {
var rec = document.getElementById('rec676028174');
var rawCode = rec.querySelector('pre code');
rawCode.textContent = rawCode.textContent.trim()
t_onFuncLoadObj(hljs.initHighlightingOnLoad);
function t_onFuncLoadObj(okFunc) {
if (typeof hljs.initHighlightingOnLoad === 'function') {
okFunc();
} else {
setTimeout(function checkFuncExist() {
if (typeof hljs.initHighlightingOnLoad === 'function') {
okFunc();
return;
}
if (document.readyState === 'complete' && typeof hljs.initHighlightingOnLoad !== 'function') {
throw new Error('hljs.initHighlightingOnLoad' + ' is undefined');
}
setTimeout(checkFuncExist, 100);
});
}
}
});</script><style type="text/css">.t264 .hljs { 
background-color: ;
}</style> </div><div id="rec676028588" class="r t-rec t-rec_pt_90 t-rec_pb_90" style="padding-top:90px;padding-bottom:90px; " data-record-type="248" ><!-- T220 --><div class="t220"><div class="t-container "><div class="t-col t-col_8 t-prefix_2"><div class="t220__textwrapper" style="background-color:#f5f5f5;"><div style=""> <div class="t220__title t-heading t-heading_sm" field="title">Упрощенный код в FileOpen1Execute()</div> <div field="text" class="t220__text t-text t-text_md ">проявление структурного программирования. Метод DragAcceptFiles() инкапсулирован в объектном конструкторе, предпочтительнее разместить в FormCreate(). Параметр Handle отражает "window handle" — аналог объектного указателя на windowed control. Второй параметр определяет разрешено или запрещено бросание файлов.<br />DragQueryFile(): Message.Drop — handle для параметров, переданных Windows. При втором параметре, равном 0xFFFFFFFF или -1, функция возвращает количество файлов; иначе — имя файла по указанному номеру. В первом варианте два последних параметра NULL, во втором — строка (char str[n]) и размер массива (unsigned int). MAXPATH — максимальный размер имени файла, определенный в &lt;dir.h&gt;. DragFinish() используется для освобождения ресурсов.<br />ExtractFileExt() возвращает расширение файла из его пути. Например, для "C:\Мои документы\super.jpg" результат — ".jpg".</div></div></div></div></div></div></div><div id="rec682303128" class="r t-rec t-rec_pt_90 t-rec_pb_90" style="padding-top:90px;padding-bottom:90px; " data-record-type="191" ><!-- T142 --><div class="t142"><div class="t-container_100"><div class="t142__wrapone"><div class="t142__wraptwo"><a class="t-btn t142__submit t-btn_md"
href="textlessons.html" target="" 
style="color:#ffffff;border:3px solid #ffffff;background-color:#1f5bff;" data-buttonfieldset="button"
><span class="t142__text">Вернуться назад</span></a></div></div></div></div><script>t_onReady(function () {
t_onFuncLoad('t142_checkSize', function () {
t142_checkSize('682303128');
});
});
window.addEventListener('load', function () {
t_onFuncLoad('t142_checkSize', function () {
t142_checkSize('682303128');
});
});</script></div></div><!--/allrecords--><!-- Tilda copyright. Don't remove this line --><div class="t-tildalabel t-tildalabel-free" id="tildacopy" data-tilda-sign="8244563#41823828"><div class="t-tildalabel-free__main"><a href="https://tilda.cc/?upm=8244563" target="_blank" style="padding-bottom:12px; display: block;"><img alt="" style="width:40px;" src="https://static.tildacdn.info/img/tildacopy.png" fetchpriority="low"></a><div style="padding-bottom: 15px;">This site was made on <a href="https://tilda.cc/?upm=8244563" target="_blank" style="text-decoration: none; color:inherit;">Tilda &mdash; a website builder</a> that helps to&nbsp;create a&nbsp;website without any code</div><a href="https://tilda.cc/registration/" target="_blank" style="display: inline-block; padding: 10px 20px; font-size: 13px; border-radius: 50px; background-color: #fff; color:#000; text-decoration: none;">Create a website</a></div><div class="t-tildalabel-free__links-wr"><a class="t-tildalabel-free__txt-link" href="https://help.tilda.cc/white-label" target="_blank">How to remove this block?</a><a class="t-tildalabel-free__txt-link" href="https://tilda.cc/?upm=8244563" target="_blank">About platform</a><a class="t-tildalabel-free__txt-link" href="https://tilda.cc/abuse/" target="_blank">Submit a complaint</a></div></div><!-- Stat --><script type="text/javascript">if (! window.mainTracker) { window.mainTracker = 'tilda'; }
window.tildastatcookie='no'; 
setTimeout(function(){ (function (d, w, k, o, g) { var n=d.getElementsByTagName(o)[0],s=d.createElement(o),f=function(){n.parentNode.insertBefore(s,n);}; s.type = "text/javascript"; s.async = true; s.key = k; s.id = "tildastatscript"; s.src=g; if (w.opera=="[object Opera]") {d.addEventListener("DOMContentLoaded", f, false);} else { f(); } })(document, window, 'c0529379dfa2258bfcd328fe5f0ee1eb','script','https://static.tildacdn.info/js/tilda-stat-1.0.min.js');
}, 2000); </script></body></html>